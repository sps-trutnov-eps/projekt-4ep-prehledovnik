<!DOCTYPE html>
<%- include('../partials/head'); %>
  <article style="width: 20vw; min-width: 20vw; margin-right: 1em; resize: horizontal;">
    <header>
      <h1 class="toClick" onclick="window.location.href='/udalosti/'">Nová událost</h1>
    </header>
    <main>
      <form 
      hx-post="/udalosti/pridatUdalost" 
      hx-target="body"
      hx-trigger="submit"
      class="event-form">
        <input
          type="text"
          name="jmeno_udalosti"
          placeholder="Název události…"
          required />

        <input
          type="radio"
          id="celodenni"
          name="variantaDni"
          value="Celodenní" 
          checked
          />
        <label for="celodenni">Celodenní</label><br />
        <input
          type="radio"
          id="vicedenni"
          name="variantaDni"
          value="Vícedenní"
          />
        <label for="vicedenni">Vícedenní</label><br />
        <input
        type="radio"
        id="jine"
        name="variantaDni"
        value="Zadat den a čas"
        />
        <label for="jine" style="margin-bottom: 1em;">Zadat den a čas</label><br />

        <label for="datum" id="datumLabel">Datum</label>
        <input type="date" id="datum" name="datum" value="<%= datum %>" min="<%= datum %>"/>

        <div id="jineInputs" style="display: none;">
          <label>Od-do</label>
          <select id="casOd" style="margin-bottom: 0.7em;" name="casOd">
            <option value="7:10">7:10</option>
            <option selected value="8:00">8:00</option>
            <option value="8:50">8:50</option>
            <option value="9:55">9:55</option>
            <option value="10:50">10:50</option>
            <option value="11:40">11:40</option>
            <option value="12:35">12:35</option>
            <option value="13:25">13:25</option>
            <option value="14:15">14:15</option>
            <option value="15:10">15:10</option>
          </select>
          <select id="casDo" style="margin-bottom: 0.4em;" name="casDo">
            <option value="7:55">7:55</option>
            <option value="8:45">8:45</option>
            <option value="9:35">9:35</option>
            <option value="10:40">10:40</option>
            <option value="11:35">11:35</option>
            <option value="12:25">12:25</option>
            <option value="13:20">13:20</option>
            <option value="14:10">14:10</option>
            <option selected value="15:00">15:00</option>
            <option value="15:55">15:55</option>
          </select>
        </div>


        <div id="vicedenniInputs" style="display: none;">
          <label for="datumDo" style="margin-bottom: 0.2em">Do</label>
          <input type="date" id="datumDo" name="datumDo"/>
        </div>

        <label for="typAkce" style="margin-bottom: 0.2em">Typ události</label>
        <select id="typAkce" name="typAkce">
          <option value="ucitelsky">Učitel</option>
          <option value="celotridni">Třída</option>
          <option value="ucebna">Učebna</option>
          <option value="budovy">Budova</option>
          <option value="celoskolni">Škola</option>
        </select>

        <div id="tridySelect" style="display: none;">
          <label for="tridy">Třídy</label>
          <select id="tridy" name="tridy">
            <% TridyObory.forEach(Trida => { %>
              <option value="<%= Trida%>"><%= Trida %></option>
            <% }) %>
          </select>
        </div>

        <div id="budovySelect" style="display: none;">
          <label for="budovy">Budovy</label>
          <select id="budovy" name="budovy">
            <option value="skolni101">Školní 101</option>
            <option value="horska618">Horská 618</option>
            <option value="horska59">Horská 59</option>
            <option value="mladeBuky">Mladé Buky</option>
          </select>
        </div>

        <div id="ucebnaInput" style="display: none;">
          <label for="ucebna">Učebna</label>
          <input type="text" id="ucebna" name="ucebna" placeholder="Zadejte učebnu…">
        </div>
        <!-- data pro změnu -->
        <input type="hidden" name="PuvodniData" value="">

        <input type="text" name="poznamka_udalosti" placeholder="Poznámka…" />
        <input type="submit" id="SaveButton" value="Přidat" />
      </form>
    </main>
  </article>

  <article style="flex: 3; overflow-y: auto">
    <header>
      <h1>Události</h1>
    </header>
    <main>
      <style>
        h1{
          margin-bottom: 0em;
        }
        .event-form {
          margin-bottom: 2em;
        }

        .events-table {
          width: 100%;
          table-layout: fixed;
          border-collapse: collapse;
        }
        
        h1.toClick:hover {
          cursor: pointer;
        }

        .events-table .toClick {
          position: relative;
          cursor: pointer;
        }
        
        .events-table td {
          padding: 8px;
          white-space: nowrap;
          overflow: visible;
          text-overflow: ellipsis;
        }
        
        .events-table td:nth-child(1) { width: 25%; }
        .events-table td:nth-child(2) { width: 15%; }
        .events-table td:nth-child(3) { width: 15%; }
        .events-table td:nth-child(4) { width: 15%; }
        .events-table td:nth-child(5) { width: 15%; }
        .events-table td:nth-child(6) { width: 10%; }
        .events-table td:nth-child(7) { width: 5%; }
        
        .delete-btn {
          background: none;
          border: none;
          color: red;
          cursor: pointer;
          padding: 5px;
        }
        
        .delete-btn:hover{
          color: darkred;
        } 

        ::-webkit-scrollbar {
          display: none;
        }

        .events-table td.empty-cell {
          padding-left: 40px;
        }

        .events-table td.empty-cell-tykaSe {
          padding-left: 30px;
          text-align: left;
        }

        .events-table td.empty-cell::after, .events-table td.empty-cell-tykaSe::after {
          content: "-";
        }

        .center {
          text-align: center; 
        }

        .center-content {
          position: relative;  
          left: -29%;         
        }
      </style>
      
      <table class="events-table">
        <% 
        const prekladVyberZadani = {
          "celodenni": "Celodenní",
          "vicedenni": "Vícedenní",
          "casIDatum": " "
        };

        const prekladTypAkce = {
          "celotridni": "Celotřídní",
          "ucebna": "Učebna",
          "budovy": "Budovy",
          "celoskolni": "Celoškolní",
          "ucitelsky": "Učitelský"
        };

        const prekladBudov = {
          "skolni101": "Školní 101",
          "horska618": "Horská 618",
          "horska59": "Horská 59",
          "mladeBuky": "Mladé Buky"
        };

        function formatDate(dateStr) {
          const date = new Date(dateStr);
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          if(day != "NaN"){
            return `${day}.${month}.${year}`;
          } 
        }
        %>
        <tr style="border-bottom: 2px solid rgba(255, 255, 255, 0.767);">
          <td>Název</td>
          <td>Typ události</td>
          <td>Datum</td>
          <td style="padding-left: 30px;">Čas</td>
          <td><span style="left: -9%; position: relative;">Datum/Čas do</span></td>
          <td>Týká se</td>
          <td style="padding-left: 0.8em;">✕</td>
        </tr>
        
        <% seznamNaZobrazeni.forEach(udalost => { %>
          <tr>
            <!-- Název události -->
            <td class="toClick" onclick="handleUdalostClick('<%= JSON.stringify(udalost) %>')">
                <%= udalost.nazev %>
            </td>
        
            <!-- Typ události -->
            <td>
              <%= prekladTypAkce[udalost.typ] || udalost.typ %>
            </td>
        
            <!-- Rozdělení podle vyberZadani a názvu události -->
            <% if (udalost.vyberZadani === "celodenni") { %>
              <td><%= formatDate(udalost.datum) %></td>
              <td class="empty-cell"></td>
              <td class="empty-cell"></td>
        
            <% } else if (udalost.vyberZadani === "vicedenni") { %>
              <td><%= formatDate(udalost.datum) %></td>
              <td class="empty-cell"></td>
              <td><%= formatDate(udalost.datumDo) %></td>
        
            <% } else if (udalost.vyberZadani === "casIDatum") { %>
              <td><%= formatDate(udalost.datum) %></td>
              <td style="padding-left: 30px;"><%= udalost.casOd %></td>
              <td style="padding-left: 30px;"><%= udalost.casDo %></td>
        
            <% } else if (udalost.vyberZadani === "maturita") { %>
              <% if (udalost.nazev === "PČMZ") { %>
                <td><%= formatDate(udalost.datum) %></td>
                <td style="padding-left: 30px;"><%= udalost.casOd %></td>
                <td style="padding-left: 30px;"><%= udalost.casDo %></td>
        
              <% } else if (udalost.nazev === "SČMZ") { %>
                <td><%= formatDate(udalost.datum) %></td>
                <td style="padding-left: 30px;"><%= udalost.casOd %></td>
                <td class="empty-cell"></td>
        
              <% } else if (udalost.nazev === "SLOH") { %>
                <td><%= formatDate(udalost.datum) %></td>
                <td style="padding-left: 30px;"><%= udalost.casOd %></td>
                <td style="padding-left: 30px;"><%= udalost.casDo %></td>
        
              <% } else if (udalost.nazev === "PZOP" || udalost.nazev === "PZOP - dodatečný termín") { %>
                <td><%= formatDate(udalost.datum) %></td>
                <td class="empty-cell"></td>
                <td class="empty-cell"></td>
              <% } %>
            <% } %>
        
            <td class="<%= udalost.tykaSe === null ? 'empty-cell-tykaSe' : 'center' %>">
              <% if (udalost.typ === "budovy") { %>
                <span class="center-content"><%= prekladBudov[udalost.tykaSe] || udalost.tykaSe %></span>
              <% } else { %>
                <span class="center-content"><%= udalost.tykaSe %></span>
              <% } %>
            </td>
        
            <!-- Tlačítko pro smazání -->
            <td>
              <% if (udalost.vyberZadani !== "maturita") { %>
                <button 
                  onclick="(async function() { 
                    const showConfirm = createConfirmPopup({
                      title: 'Smazat Událost',
                      message: 'Opravdu chcete smazat událost?',
                      confirmText: 'Smazat',
                      cancelText: 'Zrušit'
                    });
                    const confirmed = await showConfirm();
                    if(confirmed) { 
                      window.location.href = '/udalosti/smazat/<%= JSON.stringify(udalost) %>';
                    }
                  })()"
                  class="delete-btn"
                >✕</button>
              <% } else { %>
                <button 
                  style = "color: green;"
                  onclick="handleUdalostClick('<%= JSON.stringify(udalost) %>')"
                  class="delete-btn"
                >➔</button>
              <% } %>
            </td>
          </tr>
        <% }); %>        
      </table>
    </main>
  </article>

  <script src="/události/js/main.js"></script>
<%- include('../partials/tail') %>
